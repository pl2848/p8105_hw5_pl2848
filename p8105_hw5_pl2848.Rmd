---
title: "p8105_hw5_pl2848"
author: "Pei Liu"
date: "2022-11-10"
output: github_document
---

```{r, include = FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(leaflet)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_grey() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r, include = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(rvest)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1
```{r}
file_names <- list.files(path = "data")

file_names <- paste0('data/', file_names)

```


```{r}
map(file_names, read_csv)
```


```{r}
# read the file and add new column city_state
homicide = read_csv("data-homicides-master/homicide-data.csv") %>% 
  mutate(city_state = paste(city, state, sep =", "))
```




```{r}
# a function to determine whether the case was solved or not
solved_or_not = function(x){
  if(x == "Closed by arrest") {"solved"}
  else "unsolved"
}

# Added a new column to see if the case was solved or unsolved
homicide_by_city = homicide %>% 
  mutate(status = as.character(map(disposition, solved_or_not))) %>% 
  group_by(status, city_state) %>% 
  summarise(number_of_homicides = n()) %>% 
  pivot_wider(names_from = status,
              values_from = number_of_homicides) 
  


homicide_by_city_total = homicide %>% 
  mutate(status = as.character(map(disposition, solved_or_not))) %>% 
  group_by(city_state) %>% 
  summarise(number_of_homicides = n()) 
  
homicide_df = full_join(homicide_by_city,homicide_by_city_total)  

homicide_df[is.na(homicide_df)] <- 0  
homicide_df
```

save the output of prop.test as an R object, apply the broom::tidy to this object and pull the estimated proportion and confidence intervals from the resulting tidy dataframe.
```{r}
BMD_unsolved_test = prop.test(1825, 2827, p = NULL,alternative = "two.sided",conf.level = 0.95, correct = TRUE) 
  


BMD_unsolved_test = broom::tidy(BMD_unsolved_test) %>% 
  select(estimate, conf.low, conf.high)

BMD_unsolved_test
```


Now run prop.test for each of the cities in your dataset, and extract both the proportion of unsolved homicides and the confidence interval for each.
```{r}

city_prop_test = function(x,y){
  test_data = prop.test(x, y, p = NULL,conf.level = 0.95, correct = TRUE) %>%
    broom::tidy()
}

homicide_prop_test = 
tibble(
  city_state = homicide_df$city_state,
  test_result = purrr::map2(homicide_df$unsolved,homicide_df$number_of_homicides, city_prop_test)) %>% 
  unnest(cols = c(test_result)) %>% 
  select(c(city_state, estimate, conf.low, conf.high))

homicide_prop_test

```


```{r}
homicide_prop_test %>% 
  mutate(city_state = forcats::fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate))+ 
  geom_point(alpha = .5) +
  geom_boxplot() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.8) +
  labs(
    title = "Estimated Unsolved Homiside Cases Proportion by City State",
    x = "City, State",
    y = "Estimated Proportion with 95% CI",
  ) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```


## Problem 3
```{r}
norm_5000 = vector("list", 5000)


for (i in 1:5000) {
  norm_5000[[i]] = rnorm(30, mean = 0, sd = 5)
  }


multi_sample_t_test = function(x) {
  t.test(x,alternative = "two.sided",mu = 0, conf.level = 0.95) %>% 
    broom::tidy() %>% 
    select(estimate, p.value)
}

sim_5000_t_test = tibble(mean = 0,
       test_result = purrr::map(norm_5000,multi_sample_t_test)) %>% 
  unnest(test_result)

head(sim_5000_t_test)
```


Repeat the above for Î¼={1,2,3,4,5,6}, and complete the following:
```{r}
simulations = function(z,n=30, sigma = 5) {
  
  sim_data = tibble(
    x = rnorm(n , mean = z , sd = sigma),
  )
  
    t.test(sim_data, alternative = "two.sided",mu = z, conf.level = 0.95) %>%
    broom::tidy() %>%
    select(estimate,p.value)
}


sim_results_df = 
  expand_grid(
    mean = c(1,2,3,4,5,6),
    iter = 1:5000
  ) %>% 
  mutate(
    estimate_df = purrr::map(mean, simulations)
  ) %>% 
  unnest(estimate_df)



```



```{r}
null_rej_plot = sim_results_df %>% 
  filter(p.value < 0.05) %>% 
  group_by(mean) %>% 
  summarise(rej_prop = n()/5000) %>% 
  ggplot(aes(x = mean, y = rej_prop)) +
  geom_point() +
  labs(
    title = "the proportion of times the null was rejected (the power of the test) vs the true value of mu",
    x = "True mu",
    y = "The proportion of times the null was rejected (the power of the test)",
  ) 
  
  
  
ggsave("Null rejection proportion.png", null_rej_plot, width = 8, height = 5) 
null_rej_plot
```

```{r}
library(patchwork)
mean_esti_plot = sim_results_df %>% 
  group_by(mean) %>% 
  summarise(mean_estimate = mean(estimate)) %>% 
  ggplot(aes(x = mean, y = mean_estimate)) +
  geom_point() 
  
mean_esti_null_plot  = sim_results_df %>% 
  filter(p.value < 0.05) %>% 
  group_by(mean) %>% 
  summarise(mean_estimate = mean(estimate)) %>% 
  ggplot(aes(x = mean, y = mean_estimate)) +
  geom_point() 
  


plot_mean = mean_esti_plot + mean_esti_null_plot
plot_mean
ggsave("estumated mean vs mu plot.png", plot_mean, width = 8, height = 5) 
```


